---
services:
  kasm:
    image: lscr.io/linuxserver/kasm:latest
    container_name: kasm
    privileged: true
    security_opt:
      - apparmor:rootlesskit #optional
    environment:
      - KASM_PORT=443
      - DOCKER_HUB_USERNAME=USER #optional
      - DOCKER_HUB_PASSWORD=PASS #optional
      - DOCKER_MTU=1500 #optional
    volumes:
      - $DOCKERDIR/appdata/kasm/data:/opt
    networks:
      - t3_proxy
    ports:
      - "992:443"
      - "3000:3000"
    labels:
      - "traefik.enable=true"
  
      # 🧩 Setup Router (Port 3000)
      - "traefik.http.routers.kasm-setup-rtr.entrypoints=websecure"
      - "traefik.http.routers.kasm-setup-rtr.rule=Host(`setup-kasm.${DOMAINNAME_1}`)"
      - "traefik.http.routers.kasm-setup-rtr.tls.certresolver=dns-cloudflare"
      - "traefik.http.routers.kasm-setup-rtr.middlewares=chain-internal-auth@file"
      - "traefik.http.routers.kasm-setup-rtr.service=kasm-setup-svc"

      # 🔐 Internal Setup Service (HTTPS with TLS skip)
      - "traefik.http.services.kasm-setup-svc.loadbalancer.server.port=3000"
      - "traefik.http.services.kasm-setup-svc.loadbalancer.server.scheme=https"
      - "traefik.http.services.kasm-setup-svc.loadbalancer.server.skipVerify=true"
    
      # 🚀 Main Router (Port 443)
      - "traefik.http.routers.kasm-main-rtr.entrypoints=websecure"
      - "traefik.http.routers.kasm-main-rtr.rule=Host(`kasm.${DOMAINNAME_1}`)"
      - "traefik.http.routers.kasm-main-rtr.tls=true"
      - "traefik.http.routers.kasm-main-rtr.tls.certresolver=dns-cloudflare"
      - "traefik.http.routers.kasm-main-rtr.middlewares=chain-external-authentik@file"
      - "traefik.http.routers.kasm-main-rtr.service=kasm-main-svc"
      - "traefik.http.services.kasm-main-svc.loadbalancer.server.port=443"
    restart: unless-stopped